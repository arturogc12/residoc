<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Residoc | Ficha de lote</title>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module" src="./supabase.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: '#4A90E2',
                        slate: '#2D3436',
                        mint: '#B8D8D8',
                        lavender: '#E2C2FF',
                        cream: '#F9F7F2',
                    },
                    boxShadow: {
                        'soft': '0 10px 40px -10px rgba(0,0,0,0.05)',
                        'float': '0 20px 50px -12px rgba(0,0,0,0.1)',
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap');

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: #F9F7F2;
        }

        .fade-in-up {
            animation: fadeInUp 0.6s ease-out forwards;
        }

        .delay-100 {
            animation-delay: 0.1s;
            opacity: 0;
        }

        .delay-200 {
            animation-delay: 0.2s;
            opacity: 0;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>

<body class="selection:bg-mint selection:text-slate min-h-screen flex flex-col">

    <main class="flex-1 p-4 sm:p-6 lg:p-8 max-w-[1400px] mx-auto w-full">

        <!-- ===== HEADER ===== -->
        <header class="flex flex-col sm:flex-row sm:items-center justify-between mb-6 sm:mb-10 gap-4 fade-in-up">
            <div class="flex items-center gap-4 sm:gap-6">
                <button onclick="window.history.back()"
                    class="w-12 h-12 min-w-[44px] min-h-[44px] bg-white rounded-2xl shadow-sm border border-slate/5 flex items-center justify-center text-slate hover:text-brand hover:shadow-soft transition-all group">
                    <i class="ph ph-arrow-left text-xl group-hover:-translate-x-1 transition-transform"></i>
                </button>
                <div>
                    <p class="text-sm text-slate/40 font-medium mb-1">Ficha de lote</p>
                    <h1 class="text-xl sm:text-3xl font-bold text-slate tracking-tight font-mono" id="batchHeader">—
                    </h1>
                </div>
            </div>
            <div class="flex items-center gap-3">
                <div id="batchBadge"
                    class="flex items-center gap-2 bg-lavender/30 text-slate px-4 py-2 rounded-2xl text-sm font-bold">
                    <i class="ph ph-barcode text-lavender"></i>
                    <span id="batchBadgeText">—</span>
                </div>
            </div>
        </header>

        <!-- ===== BATCH INFO CARD ===== -->
        <div class="mb-8 fade-in-up delay-100">
            <div class="bg-white rounded-[32px] p-7 shadow-sm border border-slate/5">
                <div class="flex flex-wrap gap-8">
                    <div>
                        <p class="text-[10px] font-bold text-slate/30 uppercase tracking-widest mb-1">Número de lote</p>
                        <p class="text-lg font-bold text-slate font-mono" id="batchNum">—</p>
                    </div>
                    <div>
                        <p class="text-[10px] font-bold text-slate/30 uppercase tracking-widest mb-1">Total aplicaciones
                        </p>
                        <p class="text-lg font-bold text-slate" id="batchTotal">—</p>
                    </div>
                    <div>
                        <p class="text-[10px] font-bold text-slate/30 uppercase tracking-widest mb-1">Primer uso</p>
                        <p class="text-lg font-bold text-slate" id="batchFirst">—</p>
                    </div>
                    <div>
                        <p class="text-[10px] font-bold text-slate/30 uppercase tracking-widest mb-1">Último uso</p>
                        <p class="text-lg font-bold text-slate" id="batchLast">—</p>
                    </div>
                    <div>
                        <p class="text-[10px] font-bold text-slate/30 uppercase tracking-widest mb-1">Tipos de servicio
                        </p>
                        <p class="text-lg font-bold text-slate" id="batchTypes">—</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- ===== TREATMENTS TABLE ===== -->
        <section class="fade-in-up delay-200">
            <div class="bg-white rounded-[32px] shadow-sm border border-slate/5 overflow-hidden">
                <div class="px-8 py-7 flex items-center justify-between border-b border-slate/5">
                    <div>
                        <h2 class="text-lg font-bold text-slate">Servicios realizados con este lote</h2>
                        <p class="text-sm text-slate/40 mt-0.5">Trazabilidad completa de aplicaciones</p>
                    </div>
                </div>

                <div id="batchTableContainer" class="px-4 sm:px-7 pb-4">
                    <!-- Table header -->
                    <div
                        class="hidden sm:grid grid-cols-12 gap-4 text-xs font-bold text-slate/30 uppercase tracking-wider py-3 border-b border-slate/5">
                        <div class="col-span-4">Cliente</div>
                        <div class="col-span-3">Tratamiento</div>
                        <div class="col-span-3">Fotos</div>
                        <div class="col-span-2 text-right">Fecha</div>
                    </div>
                    <!-- Rows injected by JS -->
                    <div id="batchRows" class="space-y-1"></div>
                </div>
            </div>
        </section>

    </main>

    <!-- ===================== PHOTO VIEWER MODAL ===================== -->
    <div id="photoModal" class="fixed inset-0 z-[200] bg-slate/80 backdrop-blur-sm hidden items-center justify-center"
        onclick="this.classList.add('hidden');this.classList.remove('flex')">
        <div class="relative max-w-4xl w-full mx-4" onclick="event.stopPropagation()">
            <button
                onclick="document.getElementById('photoModal').classList.add('hidden');document.getElementById('photoModal').classList.remove('flex')"
                class="absolute -top-12 right-0 text-white/60 hover:text-white text-3xl transition-colors">
                <i class="ph ph-x"></i>
            </button>
            <button id="photoPrev"
                class="absolute left-0 top-1/2 -translate-y-1/2 -translate-x-14 text-white/60 hover:text-white text-3xl">
                <i class="ph ph-caret-left"></i>
            </button>
            <button id="photoNext"
                class="absolute right-0 top-1/2 -translate-y-1/2 translate-x-14 text-white/60 hover:text-white text-3xl">
                <i class="ph ph-caret-right"></i>
            </button>
            <img id="photoViewerImg" src="" class="w-full max-h-[80vh] object-contain rounded-3xl shadow-float">
            <div id="photoCounter" class="text-center text-white/40 text-sm mt-4"></div>
        </div>
    </div>

    <script type="module">
        import { supabase } from './supabase.js';

        const urlParams = new URLSearchParams(window.location.search);
        const batchNumber = urlParams.get('batch');

        if (!batchNumber) {
            document.getElementById('batchHeader').textContent = 'Lote no encontrado';
        }

        // ── Photo viewer ─────────────────────────────────────────────────────
        let _photos = [], _photoIdx = 0;
        function openPhotoViewer(urls, idx = 0) {
            _photos = urls; _photoIdx = idx;
            showPhoto();
            const m = document.getElementById('photoModal');
            m.classList.remove('hidden'); m.classList.add('flex');
        }
        function showPhoto() {
            document.getElementById('photoViewerImg').src = _photos[_photoIdx];
            document.getElementById('photoCounter').textContent = `${_photoIdx + 1} / ${_photos.length}`;
        }
        document.getElementById('photoPrev').addEventListener('click', () => {
            _photoIdx = (_photoIdx - 1 + _photos.length) % _photos.length; showPhoto();
        });
        document.getElementById('photoNext').addEventListener('click', () => {
            _photoIdx = (_photoIdx + 1) % _photos.length; showPhoto();
        });

        // ── Load batch data ───────────────────────────────────────────────────
        async function fetchBatchData() {
            if (!batchNumber) return;

            document.getElementById('batchHeader').textContent = batchNumber;
            document.getElementById('batchBadgeText').textContent = batchNumber;
            document.getElementById('batchNum').textContent = batchNumber;

            const { data: treatments, error } = await supabase
                .from('treatments')
                .select('*, clients(id, full_name, dni, phone)')
                .eq('batch_number', batchNumber)
                .order('created_at', { ascending: false });

            if (error || !treatments) return;

            // ── Summary stats ─────────────────────────────────────────────────
            document.getElementById('batchTotal').textContent = treatments.length;
            if (treatments.length > 0) {
                const sorted = [...treatments].sort((a, b) => new Date(a.created_at) - new Date(b.created_at));
                document.getElementById('batchFirst').textContent =
                    new Date(sorted[0].created_at).toLocaleDateString('es-ES', { day: 'numeric', month: 'long', year: 'numeric' });
                document.getElementById('batchLast').textContent =
                    new Date(sorted[sorted.length - 1].created_at).toLocaleDateString('es-ES', { day: 'numeric', month: 'long', year: 'numeric' });
                const types = [...new Set(treatments.map(t => t.type).filter(Boolean))];
                document.getElementById('batchTypes').textContent = types.length > 0 ? types.join(', ') : '—';
            }

            // ── Rows ──────────────────────────────────────────────────────────
            const rowsContainer = document.getElementById('batchRows');
            rowsContainer.innerHTML = '';

            if (treatments.length === 0) {
                rowsContainer.innerHTML = `<p class="text-sm text-slate/30 py-10 text-center">No hay servicios con este lote</p>`;
                return;
            }

            treatments.forEach(t => {
                const client = t.clients;
                const date = new Date(t.created_at).toLocaleDateString('es-ES', { day: 'numeric', month: 'short' });
                const photos = t.photo_urls || [];

                const row = document.createElement('div');
                row.className = 'grid grid-cols-12 gap-4 items-center py-4 border-b border-slate/5 hover:bg-cream/50 transition-colors rounded-xl px-1 group';
                row.innerHTML = `
                    <!-- Client -->
                    <a href="client-file.html?id=${client?.id}" class="col-span-4 flex items-center gap-3 cursor-pointer">
                        <img src="https://ui-avatars.com/api/?name=${encodeURIComponent(client?.full_name || '?')}&background=B8D8D8&color=4A4E69&bold=true"
                             class="w-9 h-9 rounded-full flex-shrink-0">
                        <div class="min-w-0">
                            <div class="text-sm font-bold text-slate group-hover:text-brand transition-colors truncate">${client?.full_name || '—'}</div>
                            <div class="text-xs text-slate/40">DNI: ${client?.dni || '—'}</div>
                        </div>
                    </a>
                    <!-- Service type -->
                    <div class="col-span-3">
                        <span class="text-xs bg-lavender/20 text-slate px-3 py-1.5 rounded-lg font-medium inline-flex items-center gap-1.5">
                            <i class="ph ph-eyedropper text-lavender"></i> ${t.type || '—'}
                        </span>
                    </div>
                    <!-- Photos -->
                    <div class="col-span-3">
                        ${photos.length > 0
                        ? `<button onclick="openPhotoViewer([${photos.map(u => `'${u}'`).join(',')}], 0)"
                                class="flex items-center gap-1.5 text-xs text-brand font-bold hover:underline">
                                <i class="ph ph-images"></i> ${photos.length} foto${photos.length > 1 ? 's' : ''}
                               </button>`
                        : `<span class="text-xs text-slate/30">Sin fotos</span>`
                    }
                    </div>
                    <!-- Date -->
                    <div class="col-span-2 text-right text-xs text-slate/40 font-medium">${date}</div>
                `;
                rowsContainer.appendChild(row);
            });
        }

        // Make openPhotoViewer accessible from inline onclick
        window.openPhotoViewer = openPhotoViewer;

        fetchBatchData();
    </script>

</body>

</html>