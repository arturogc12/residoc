<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Residoc | Ficha de cliente</title>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Supabase Client -->
    <script type="module" src="./supabase.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: '#4A90E2',
                        slate: '#2D3436',
                        mint: '#B8D8D8',
                        lavender: '#E2C2FF',
                        cream: '#F9F7F2',
                    },
                    boxShadow: {
                        'soft': '0 10px 40px -10px rgba(0,0,0,0.05)',
                        'float': '0 20px 50px -12px rgba(0,0,0,0.1)',
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap');

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: #F9F7F2;
        }

        .fade-in-up {
            animation: fadeInUp 0.6s ease-out forwards;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>

<body class="selection:bg-mint selection:text-slate min-h-screen flex flex-col">

    <!-- ===================== MAIN CONTENT ===================== -->
    <main class="flex-1 p-4 sm:p-6 lg:p-8 max-w-[1400px] mx-auto w-full">

        <!-- ===== HEADER (Back to Dashboard) ===== -->
        <header class="flex flex-col sm:flex-row sm:items-center justify-between mb-6 sm:mb-10 gap-4 fade-in-up">
            <div class="flex items-center gap-4 sm:gap-6">
                <button onclick="window.location.href='dashboard.html'"
                    class="w-12 h-12 min-w-[44px] min-h-[44px] bg-white rounded-2xl shadow-sm border border-slate/5 flex items-center justify-center text-slate hover:text-brand hover:shadow-soft transition-all group">
                    <i class="ph ph-arrow-left text-xl group-hover:-translate-x-1 transition-transform"></i>
                </button>
                <div>
                    <p class="text-sm text-slate/40 font-medium mb-1">Ficha de cliente</p>
                    <h1 class="text-xl sm:text-3xl font-bold text-slate tracking-tight" id="clientNameHeader">María
                        Gómez</h1>
                </div>
            </div>

            <div class="flex items-center gap-3" id="headerActions">
                <!-- View mode -->
                <div id="viewModeActions" class="flex items-center gap-3">
                    <button id="editProfileBtn"
                        class="bg-white px-4 sm:px-5 py-3 rounded-2xl shadow-sm border border-slate/5 text-sm font-bold text-slate hover:shadow-soft transition-all flex items-center gap-2 min-h-[44px]">
                        <i class="ph ph-note-pencil"></i> <span class="hidden sm:inline">Editar perfil</span><span
                            class="sm:hidden">Editar</span>
                    </button>
                    <button id="cfOpenServiceBtn"
                        class="bg-brand text-white px-4 sm:px-5 py-3 rounded-2xl shadow-sm font-bold text-sm hover:shadow-float hover:-translate-y-0.5 transition-all flex items-center gap-2 min-h-[44px]">
                        <i class="ph ph-plus"></i> <span class="hidden sm:inline">Nuevo servicio</span><span
                            class="sm:hidden">Nuevo</span>
                    </button>
                </div>
                <!-- Edit mode (hidden by default) -->
                <div id="editModeActions" class="hidden flex items-center gap-3">
                    <button id="cancelEditBtn"
                        class="bg-white px-5 py-3 rounded-2xl shadow-sm border border-slate/5 text-sm font-bold text-slate hover:shadow-soft transition-all flex items-center gap-2">
                        <i class="ph ph-x"></i> Cancelar
                    </button>
                    <button id="saveProfileBtn"
                        class="bg-brand text-white px-5 py-3 rounded-2xl shadow-sm font-bold text-sm hover:shadow-float hover:-translate-y-0.5 transition-all flex items-center gap-2">
                        <i class="ph ph-floppy-disk"></i> Guardar cambios
                    </button>
                </div>
            </div>
        </header>

        <!-- ===== CLIENT INFO GRID ===== -->
        <div class="mb-16 fade-in-up delay-100">
            <!-- Basic Details -->
            <div class="col-span-2 bg-white rounded-[32px] p-8 shadow-sm border border-slate/5 transition-all"
                id="profileCard">
                <div class="flex items-center gap-6 mb-8">
                    <img id="clientAvatar"
                        src="https://ui-avatars.com/api/?name=Maria+G&background=B8D8D8&color=4A4E69&bold=true&size=128"
                        class="w-16 sm:w-24 h-16 sm:h-24 rounded-2xl sm:rounded-3xl object-cover shadow-sm flex-shrink-0">
                    <div class="flex-1 min-w-0">
                        <!-- View mode -->
                        <div id="profileViewMode">
                            <div class="flex items-center gap-3 mb-2">
                                <h2 class="text-xl font-bold text-slate" id="clientNameTitle">—</h2>
                                <span
                                    class="px-3 py-1 bg-green-50 text-green-600 text-[10px] font-extrabold uppercase tracking-widest rounded-full border border-green-100">Activo</span>
                            </div>
                            <div class="flex items-center gap-4 text-sm text-slate/40" id="clientMeta">
                                <span class="flex items-center gap-1.5"><i class="ph ph-identification-card"></i>
                                    —</span>
                                <span class="flex items-center gap-1.5"><i class="ph ph-phone"></i> —</span>
                            </div>
                        </div>
                        <!-- Edit mode (hidden by default) -->
                        <div id="profileEditMode" class="hidden space-y-3">
                            <div>
                                <label
                                    class="text-[10px] font-bold text-slate/30 uppercase tracking-widest block mb-1">Nombre
                                    completo</label>
                                <input id="inlineNameInput" type="text"
                                    class="w-full bg-cream border border-slate/10 rounded-xl py-2.5 px-4 text-sm font-bold text-slate outline-none focus:ring-2 focus:ring-brand/20 focus:border-brand/30 transition-all">
                            </div>
                            <div>
                                <label
                                    class="text-[10px] font-bold text-slate/30 uppercase tracking-widest block mb-1">Teléfono</label>
                                <div class="relative">
                                    <i
                                        class="ph ph-phone absolute left-3.5 top-1/2 -translate-y-1/2 text-slate/30 text-sm"></i>
                                    <input id="inlinePhoneInput" type="tel" placeholder="+34 600 000 000"
                                        class="w-full bg-cream border border-slate/10 rounded-xl py-2.5 pl-9 pr-4 text-sm font-medium text-slate outline-none focus:ring-2 focus:ring-brand/20 focus:border-brand/30 transition-all">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-3 gap-4 sm:gap-6 pt-6 sm:pt-8 border-t border-slate/5">
                    <div>
                        <p class="text-[10px] font-bold text-slate/30 uppercase tracking-widest mb-1">Última visita</p>
                        <p class="text-sm font-bold text-slate" id="lastVisitDate">—</p>
                    </div>
                    <div>
                        <p class="text-[10px] font-bold text-slate/30 uppercase tracking-widest mb-1">Total servicios
                        </p>
                        <p class="text-sm font-bold text-slate" id="totalServices">—</p>
                    </div>
                    <div>
                        <p class="text-[10px] font-bold text-slate/30 uppercase tracking-widest mb-1">Cliente desde</p>
                        <p class="text-sm font-bold text-slate" id="memberSince">—</p>
                    </div>
                </div>
            </div>
        </div><!-- end client info -->

        <!-- ===== HISTORIAL DE SERVICIOS ===== -->
        <section class="fade-in-up delay-200">
            <div class="bg-white rounded-[32px] shadow-sm border border-slate/5 overflow-hidden">
                <div class="px-8 py-7 flex items-center justify-between border-b border-slate/5">
                    <div>
                        <h2 class="text-lg font-bold text-slate">Historial de tratamientos</h2>
                        <p class="text-sm text-slate/40 mt-0.5">Trazabilidad completa por servicio</p>
                    </div>
                    <button class="text-sm font-bold text-brand flex items-center gap-2 hover:gap-3 transition-all">
                        Descargar historial completo <i class="ph ph-download-simple"></i>
                    </button>
                </div>

                <div class="px-8 pb-4">
                    <!-- Table Header -->
                    <div
                        class="grid grid-cols-12 gap-4 text-[10px] font-bold text-slate/30 uppercase tracking-widest py-4">
                        <div class="col-span-2">Fecha</div>
                        <div class="col-span-3">Tratamiento</div>
                        <div class="col-span-3">Lote / Producto</div>
                        <div class="col-span-2">ID Registro</div>
                        <div class="col-span-1 text-center">Fotos</div>
                        <div class="col-span-1 text-right">Acción</div>
                    </div>

                    <!-- History Rows will be injected by JS -->
                    <div class="space-y-1" id="historyContainer"></div>
                </div>
            </div>
        </section>
    </main>

    <!-- ===================== PHOTO VIEWER MODAL ===================== -->
    <div id="photoModal" class="fixed inset-0 z-[200] bg-slate/80 backdrop-blur-sm hidden items-center justify-center"
        onclick="this.classList.add('hidden');this.classList.remove('flex')">
        <div class="relative max-w-4xl w-full mx-4" onclick="event.stopPropagation()">
            <button
                onclick="document.getElementById('photoModal').classList.add('hidden');document.getElementById('photoModal').classList.remove('flex')"
                class="absolute -top-12 right-0 text-white/60 hover:text-white text-3xl transition-colors">
                <i class="ph ph-x"></i>
            </button>
            <!-- prev / next -->
            <button id="photoPrev"
                class="absolute left-0 top-1/2 -translate-y-1/2 -translate-x-14 text-white/60 hover:text-white text-3xl">
                <i class="ph ph-caret-left"></i>
            </button>
            <button id="photoNext"
                class="absolute right-0 top-1/2 -translate-y-1/2 translate-x-14 text-white/60 hover:text-white text-3xl">
                <i class="ph ph-caret-right"></i>
            </button>
            <img id="photoViewerImg" src="" class="w-full max-h-[80vh] object-contain rounded-3xl shadow-float">
            <div id="photoCounter" class="text-center text-white/40 text-sm mt-4"></div>
        </div>
    </div>

    <!-- ===================== NEW SERVICE MODAL (Client File) ===================== -->
    <div id="cfNewServiceModal"
        class="fixed inset-0 z-[100] bg-slate/20 backdrop-blur-sm hidden items-start justify-center pt-[10vh]">
        <div
            class="bg-white rounded-[32px] shadow-float w-full max-w-lg mx-4 overflow-hidden border border-slate/10 animate-[fadeInUp_0.3s_ease]">
            <div class="px-8 py-6 border-b border-slate/5 flex items-center justify-between">
                <div>
                    <h2 class="text-xl font-bold text-slate">Nuevo servicio</h2>
                    <p class="text-xs text-slate/40 mt-1" id="cfServiceClientLabel">Registrar tratamiento</p>
                </div>
                <button id="cfCloseService"
                    class="text-slate/20 hover:text-slate transition-colors text-2xl min-w-[44px] min-h-[44px] flex items-center justify-center">
                    <i class="ph ph-x"></i>
                </button>
            </div>

            <form id="cfNewServiceForm" class="p-8 space-y-5 overflow-y-auto max-h-[75vh]">
                <div class="space-y-2">
                    <label class="text-[10px] font-bold text-slate/30 uppercase tracking-widest px-1">Tipo de
                        servicio</label>
                    <div class="relative">
                        <i class="ph ph-eyedropper absolute left-4 top-1/2 -translate-y-1/2 text-slate/30"></i>
                        <select id="cfServiceType" required
                            class="w-full bg-cream border border-slate/5 rounded-2xl py-3.5 pl-11 pr-4 outline-none focus:ring-2 focus:ring-brand/20 focus:border-brand/30 transition-all text-sm font-medium text-slate appearance-none">
                            <option value="">Selecciona un servicio...</option>
                            <option>Ácido Hialurónico</option>
                            <option>Botox</option>
                            <option>Microblading</option>
                            <option>Micropigmentación</option>
                            <option>Peeling Químico</option>
                            <option>Mesoterapia</option>
                            <option>Plasma Rico en Plaquetas</option>
                            <option>Tatuaje</option>
                            <option>Láser</option>
                            <option>Otro</option>
                        </select>
                    </div>
                </div>

                <!-- Photos -->
                <div class="space-y-2">
                    <label
                        class="text-[10px] font-bold text-slate/30 uppercase tracking-widest px-1">Fotografías</label>
                    <div class="grid grid-cols-2 gap-3">
                        <button type="button" id="cfBtnCamera"
                            class="flex items-center justify-center gap-2 py-3.5 bg-cream rounded-2xl border border-slate/5 text-sm font-bold text-slate hover:bg-slate/5 transition-colors min-h-[44px]">
                            <i class="ph ph-camera text-brand"></i> Cámara
                        </button>
                        <button type="button" id="cfBtnGallery"
                            class="flex items-center justify-center gap-2 py-3.5 bg-cream rounded-2xl border border-slate/5 text-sm font-bold text-slate hover:bg-slate/5 transition-colors min-h-[44px]">
                            <i class="ph ph-images text-brand"></i> Galería
                        </button>
                    </div>
                    <input type="file" id="cfInputCamera" accept="image/*" capture="environment" class="hidden"
                        multiple>
                    <input type="file" id="cfInputGallery" accept="image/*" class="hidden" multiple>
                    <div id="cfPhotoPreview" class="hidden flex gap-2 flex-wrap pt-1"></div>
                    <div id="cfOcrStatus" class="hidden items-center gap-2 text-xs text-slate/50 mt-1">
                        <div class="w-3 h-3 rounded-full bg-lavender/60 animate-pulse"></div>
                        <span>Leyendo número de lote con IA…</span>
                    </div>
                </div>

                <!-- Batch number -->
                <div class="space-y-2">
                    <div class="flex items-center justify-between px-1">
                        <label class="text-[10px] font-bold text-slate/30 uppercase tracking-widest">Número de
                            lote</label>
                        <span class="text-[9px] text-brand/60 font-bold uppercase tracking-widest"
                            id="cfBatchAutoLabel"></span>
                    </div>
                    <div class="relative">
                        <i class="ph ph-barcode absolute left-4 top-1/2 -translate-y-1/2 text-slate/30"></i>
                        <input type="text" id="cfBatchInput" placeholder="Foto, escáner o manual"
                            class="w-full bg-cream border border-slate/5 rounded-2xl py-3.5 pl-11 pr-4 outline-none focus:ring-2 focus:ring-brand/20 focus:border-brand/30 transition-all text-sm font-medium text-slate">
                    </div>
                </div>

                <button type="submit" id="cfSubmitBtn"
                    class="w-full bg-brand text-white py-4 rounded-2xl font-bold text-sm hover:shadow-float hover:-translate-y-0.5 transition-all active:scale-95 min-h-[44px]">
                    Registrar servicio
                </button>
            </form>
        </div>
    </div>

    <!-- Tesseract.js OCR -->
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>

    <script type="module">
        import { supabase } from './supabase.js';

        const urlParams = new URLSearchParams(window.location.search);
        const clientId = urlParams.get('id');

        async function fetchClientData() {
            if (!clientId) {
                document.getElementById('clientNameHeader').textContent = 'Cliente no encontrado';
                return;
            }

            // ── Fetch Client Info ─────────────────────────────────────────────
            const { data: client, error: clientError } = await supabase
                .from('clients')
                .select('*')
                .eq('id', clientId)
                .single();

            if (clientError || !client) {
                console.error('Error fetching client:', clientError);
                return;
            }

            // ── Update header & profile card ──────────────────────────────────
            document.getElementById('clientNameHeader').textContent = client.full_name;
            document.getElementById('clientNameTitle').textContent = client.full_name;
            document.getElementById('clientAvatar').src =
                `https://ui-avatars.com/api/?name=${encodeURIComponent(client.full_name)}&background=B8D8D8&color=4A4E69&bold=true&size=128`;

            document.getElementById('clientMeta').innerHTML = `
                <span class="flex items-center gap-1.5"><i class="ph ph-identification-card"></i> ${client.dni}</span>
                <span class="flex items-center gap-1.5"><i class="ph ph-phone"></i> ${client.phone || 'Sin teléfono'}</span>
            `;

            // ── Fetch Treatment History ───────────────────────────────────────
            const { data: treatments, error: treatError } = await supabase
                .from('treatments')
                .select('*')
                .eq('client_id', clientId)
                .order('created_at', { ascending: false });

            if (treatError) {
                console.error('Error fetching treatments:', treatError);
                return;
            }

            // ── Update stats ──────────────────────────────────────────────────
            document.getElementById('totalServices').textContent =
                treatments.length > 0 ? `${treatments.length} registrado${treatments.length > 1 ? 's' : ''}` : '0 registros';

            document.getElementById('lastVisitDate').textContent =
                treatments.length > 0
                    ? new Date(treatments[0].created_at).toLocaleDateString('es-ES', { day: 'numeric', month: 'short', year: 'numeric' })
                    : '—';

            document.getElementById('memberSince').textContent =
                new Date(client.created_at).toLocaleDateString('es-ES', { day: 'numeric', month: 'short', year: 'numeric' });

            // ── Render History Rows ───────────────────────────────────────────
            const historyContainer = document.getElementById('historyContainer');
            historyContainer.innerHTML = '';

            if (treatments.length === 0) {
                historyContainer.innerHTML = `
                    <p class="text-sm text-slate/30 py-10 text-center">Aún no hay tratamientos registrados para este cliente.</p>
                `;
                return;
            }

            treatments.forEach(item => {
                const date = new Date(item.created_at).toLocaleDateString('es-ES', { day: 'numeric', month: 'short', year: 'numeric' });
                const row = document.createElement('div');
                row.className = 'grid grid-cols-12 gap-4 items-center py-4 border-t border-slate/5 hover:bg-cream/50 transition-colors rounded-2xl px-2 group';
                const photos = item.photo_urls || [];
                row.innerHTML = `
                    <div class="col-span-2 text-sm font-bold text-slate">${date}</div>
                    <div class="col-span-3 flex items-center gap-3">
                        <div class="w-8 h-8 rounded-lg bg-lavender/20 text-slate flex items-center justify-center">
                            <i class="ph ph-eyedropper"></i>
                        </div>
                        <span class="text-sm font-semibold text-slate">${item.type}</span>
                    </div>
                    <div class="col-span-3">
                        <span class="text-xs font-mono text-slate/50">${item.batch_number || '—'}</span>
                    </div>
                    <div class="col-span-2 text-xs font-mono text-brand font-bold">${item.registration_id}</div>
                    <div class="col-span-1 text-center">
                        ${photos.length > 0
                        ? `<button class="view-photos-btn text-xs bg-lavender/20 text-slate px-2 py-1.5 rounded-lg font-bold flex items-center gap-1 mx-auto hover:bg-lavender/40 transition-colors" data-photos='${JSON.stringify(photos)}'>
                                <i class="ph ph-images"></i> ${photos.length}
                               </button>`
                        : `<span class="text-xs text-slate/20">—</span>`
                    }
                    </div>
                    <div class="col-span-1 text-right">
                        <i class="ph ph-dots-three-outline-vertical text-slate/20 group-hover:text-slate transition-colors"></i>
                    </div>
                `;
                historyContainer.appendChild(row);
            });

            // ── Photo Viewer ───────────────────────────────────────────────────
            let _photoList = [], _photoIdx = 0;

            function openPhotoViewer(photos, startIndex = 0) {
                _photoList = photos;
                _photoIdx = startIndex;
                showPhoto();
                const modal = document.getElementById('photoModal');
                modal.classList.remove('hidden');
                modal.classList.add('flex');
            }

            function showPhoto() {
                document.getElementById('photoViewerImg').src = _photoList[_photoIdx];
                document.getElementById('photoCounter').textContent = `${_photoIdx + 1} / ${_photoList.length}`;
            }

            document.getElementById('photoPrev').onclick = e => { e.stopPropagation(); _photoIdx = (_photoIdx - 1 + _photoList.length) % _photoList.length; showPhoto(); };
            document.getElementById('photoNext').onclick = e => { e.stopPropagation(); _photoIdx = (_photoIdx + 1) % _photoList.length; showPhoto(); };

            document.getElementById('historyContainer').addEventListener('click', e => {
                const btn = e.target.closest('.view-photos-btn');
                if (!btn) return;
                const photos = JSON.parse(btn.dataset.photos);
                openPhotoViewer(photos, 0);
            });
            // ── Render notes ──────────────────────────────────────────────────
            currentClient = client;
            renderNotes(client.notes);
        }

        // ── Shared state ──────────────────────────────────────────────────────
        let currentClient = null;

        // ── Notes renderer ────────────────────────────────────────────────────
        function renderNotes(notes) {
            const el = document.getElementById('notesDisplay');
            if (notes && notes.trim()) {
                el.innerHTML = `<p class="text-xs text-slate/70 leading-relaxed whitespace-pre-wrap">${notes}</p>`;
            } else {
                el.innerHTML = `<p class="text-xs text-slate/40 italic">Sin notas. Haz clic en 'Editar perfil' para añadir.</p>`;
            }
        }

        // ── Inline Edit Mode ────────────────────────────────────────────────────
        const editProfileBtn = document.getElementById('editProfileBtn');
        const cancelEditBtn = document.getElementById('cancelEditBtn');
        const saveProfileBtn = document.getElementById('saveProfileBtn');
        const viewModeActions = document.getElementById('viewModeActions');
        const editModeActions = document.getElementById('editModeActions');

        function enterEditMode() {
            // Populate inline inputs with current values
            document.getElementById('inlineNameInput').value = currentClient?.full_name || '';
            document.getElementById('inlinePhoneInput').value = currentClient?.phone || '';

            // Show edit fields, hide view fields
            document.getElementById('profileViewMode').classList.add('hidden');
            document.getElementById('profileEditMode').classList.remove('hidden');
            document.getElementById('notesDisplayMode').classList.add('hidden');
            document.getElementById('notesEditMode').classList.remove('hidden');

            // Swap header buttons
            viewModeActions.classList.add('hidden');
            editModeActions.classList.remove('hidden');

            // Ring highlight on card
            document.getElementById('profileCard').classList.add('ring-2', 'ring-brand/10');

            setTimeout(() => document.getElementById('inlineNameInput').focus(), 100);
        }

        function exitEditMode() {
            // Show view fields, hide edit fields
            document.getElementById('profileViewMode').classList.remove('hidden');
            document.getElementById('profileEditMode').classList.add('hidden');

            // Swap header buttons back
            viewModeActions.classList.remove('hidden');
            editModeActions.classList.add('hidden');

            // Remove ring
            document.getElementById('profileCard').classList.remove('ring-2', 'ring-brand/10');
        }

        editProfileBtn.addEventListener('click', enterEditMode);
        cancelEditBtn.addEventListener('click', exitEditMode);

        saveProfileBtn.addEventListener('click', async () => {
            const name = document.getElementById('inlineNameInput').value.trim();
            const phone = document.getElementById('inlinePhoneInput').value.trim();

            saveProfileBtn.innerHTML = '<i class="ph ph-spinner animate-spin"></i> Guardando...';
            saveProfileBtn.disabled = true;

            const { error } = await supabase
                .from('clients')
                .update({ full_name: name, phone })
                .eq('id', clientId);

            saveProfileBtn.innerHTML = '<i class="ph ph-floppy-disk"></i> Guardar cambios';
            saveProfileBtn.disabled = false;

            if (error) {
                console.error('Error saving:', error);
                alert('Error al guardar. Inténtalo de nuevo.');
                return;
            }

            // Update local state
            currentClient.full_name = name;
            currentClient.phone = phone;
            currentClient.notes = notes;

            // Refresh view mode display
            document.getElementById('clientNameHeader').textContent = name;
            document.getElementById('clientNameTitle').textContent = name;
            document.getElementById('clientAvatar').src =
                `https://ui-avatars.com/api/?name=${encodeURIComponent(name)}&background=B8D8D8&color=4A4E69&bold=true&size=128`;
            document.getElementById('clientMeta').innerHTML = `
                <span class="flex items-center gap-1.5"><i class="ph ph-identification-card"></i> ${currentClient.dni}</span>
                <span class="flex items-center gap-1.5"><i class="ph ph-phone"></i> ${phone || 'Sin teléfono'}</span>
            `;
            renderNotes(notes);
            exitEditMode();
        });

        document.addEventListener('keydown', e => {
            if (e.key === 'Escape') exitEditMode();
        });

        // ── New Service Modal (Client File) ────────────────────────────────
        const cfModal = document.getElementById('cfNewServiceModal');
        const cfForm = document.getElementById('cfNewServiceForm');
        let cfSelectedFiles = [];

        document.getElementById('cfOpenServiceBtn').addEventListener('click', () => {
            document.getElementById('cfServiceClientLabel').textContent = currentClient ? currentClient.full_name : 'Registrar tratamiento';
            cfForm.reset();
            cfSelectedFiles = [];
            document.getElementById('cfPhotoPreview').innerHTML = '';
            document.getElementById('cfPhotoPreview').classList.add('hidden');
            document.getElementById('cfBatchAutoLabel').textContent = '';
            cfModal.classList.remove('hidden');
            cfModal.classList.add('flex');
        });

        document.getElementById('cfCloseService').addEventListener('click', () => {
            cfModal.classList.add('hidden');
            cfModal.classList.remove('flex');
        });
        cfModal.addEventListener('click', e => {
            if (e.target === cfModal) { cfModal.classList.add('hidden'); cfModal.classList.remove('flex'); }
        });

        // Photo handling
        document.getElementById('cfBtnCamera').addEventListener('click', () => document.getElementById('cfInputCamera').click());
        document.getElementById('cfBtnGallery').addEventListener('click', () => document.getElementById('cfInputGallery').click());

        function handleCfFiles(files) {
            const preview = document.getElementById('cfPhotoPreview');
            for (const file of files) {
                cfSelectedFiles.push(file);
                const url = URL.createObjectURL(file);
                const thumb = document.createElement('div');
                thumb.className = 'relative w-16 h-16 rounded-xl overflow-hidden border border-slate/10';
                thumb.innerHTML = `<img src="${url}" class="w-full h-full object-cover">
                    <button type="button" class="absolute -top-1 -right-1 w-5 h-5 bg-red-500 text-white rounded-full text-[10px] flex items-center justify-center"
                        onclick="this.parentElement.remove();cfSelectedFiles.splice(${cfSelectedFiles.length - 1},1)">&times;</button>`;
                preview.appendChild(thumb);
            }
            preview.classList.remove('hidden');

            // OCR on first photo
            if (cfSelectedFiles.length === 1 && typeof Tesseract !== 'undefined') {
                const ocrStatus = document.getElementById('cfOcrStatus');
                ocrStatus.classList.remove('hidden');
                ocrStatus.classList.add('flex');
                Tesseract.recognize(cfSelectedFiles[0], 'eng').then(({ data }) => {
                    const match = data.text.match(/[A-Z0-9]{2,}[-/][A-Z0-9]{2,}[-/]?[A-Z0-9]*/i);
                    if (match) {
                        document.getElementById('cfBatchInput').value = match[0];
                        document.getElementById('cfBatchAutoLabel').textContent = '\u2713 Detectado con IA';
                    }
                    ocrStatus.classList.add('hidden');
                    ocrStatus.classList.remove('flex');
                }).catch(() => { ocrStatus.classList.add('hidden'); ocrStatus.classList.remove('flex'); });
            }
        }

        document.getElementById('cfInputCamera').addEventListener('change', e => handleCfFiles(e.target.files));
        document.getElementById('cfInputGallery').addEventListener('change', e => handleCfFiles(e.target.files));

        // Submit
        cfForm.addEventListener('submit', async e => {
            e.preventDefault();
            const type = document.getElementById('cfServiceType').value;
            const batch = document.getElementById('cfBatchInput').value.trim();
            const regId = `#RES-${Math.floor(10000 + Math.random() * 90000)}`;

            const submitBtn = document.getElementById('cfSubmitBtn');
            submitBtn.textContent = 'Registrando...';
            submitBtn.disabled = true;

            // Upload photos
            const photoUrls = [];
            for (const file of cfSelectedFiles) {
                const ext = file.name.split('.').pop();
                const path = `${clientId}/${Date.now()}_${Math.random().toString(36).slice(2)}.${ext}`;
                const { error: upErr } = await supabase.storage.from('treatment-photos').upload(path, file);
                if (!upErr) {
                    const { data: urlData } = supabase.storage.from('treatment-photos').getPublicUrl(path);
                    photoUrls.push(urlData.publicUrl);
                }
            }

            // Insert treatment
            const { error } = await supabase.from('treatments').insert({
                client_id: clientId,
                type,
                batch_number: batch || null,
                registration_id: regId,
                photo_urls: photoUrls
            });

            submitBtn.textContent = 'Registrar servicio';
            submitBtn.disabled = false;

            if (error) {
                console.error('Error:', error);
                alert('Error al registrar. Int\u00e9ntalo de nuevo.');
                return;
            }

            // Close modal and reload data
            cfModal.classList.add('hidden');
            cfModal.classList.remove('flex');
            cfForm.reset();
            cfSelectedFiles = [];
            document.getElementById('cfPhotoPreview').innerHTML = '';
            document.getElementById('cfPhotoPreview').classList.add('hidden');
            document.getElementById('cfBatchAutoLabel').textContent = '';
            fetchClientData(); // Refresh the history table
        });

        // ── Init ──────────────────────────────────────────────────────────────
        fetchClientData();
    </script>
</body>

</html>