<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Residuos biosanitarios | Residoc</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script type="module" src="./supabase.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Outfit', 'sans-serif'] },
                    colors: {
                        cream: '#F9F7F2', mint: '#B8D8D8', lavender: '#E2C2FF',
                        slate: '#353b48', brand: { DEFAULT: '#3972B6', dark: '#2d5a92' }
                    },
                    boxShadow: {
                        'soft': '0 20px 40px -15px rgba(74,78,105,0.08)',
                        'float': '0 30px 60px -20px rgba(74,78,105,0.12)',
                    }
                }
            }
        }
    </script>
    <style>
        body {
            background-color: #F9F7F2;
            color: #4A4E69;
            -webkit-font-smoothing: antialiased;
        }

        .fade-in-up {
            animation: fadeInUp 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards;
            opacity: 0;
            transform: translateY(20px);
        }

        @keyframes fadeInUp {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .delay-100 {
            animation-delay: 100ms;
        }

        .delay-200 {
            animation-delay: 200ms;
        }

        .search-overlay {
            backdrop-filter: blur(8px);
            background: rgba(53, 59, 72, 0.3);
        }
    </style>
</head>

<body class="selection:bg-mint selection:text-slate min-h-screen flex flex-col">
    <nav id="mainNav"></nav>

    <main class="flex-1 p-4 sm:p-6 lg:p-8 max-w-[1200px] mx-auto w-full">
        <!-- HEADER -->
        <header class="flex flex-col sm:flex-row sm:items-center justify-between mb-8 gap-4 fade-in-up">
            <div>
                <p class="text-sm text-slate/40 font-medium mb-1">Módulo de compliance</p>
                <h1 class="text-2xl sm:text-3xl font-bold text-slate tracking-tight flex items-center gap-3">
                    <span class="w-10 h-10 rounded-2xl bg-amber-50 flex items-center justify-center">
                        <i class="ph-fill ph-biohazard text-amber-500 text-xl"></i>
                    </span>
                    Residuos biosanitarios
                </h1>
                <p class="text-slate/40 text-sm mt-1">Clase III — Registro de retiradas por gestor autorizado</p>
            </div>
            <button onclick="openModal()"
                class="bg-amber-500 text-white px-6 py-3 rounded-2xl font-bold text-sm hover:bg-amber-600 transition-all flex items-center gap-2 shadow-sm hover:shadow-soft">
                <i class="ph ph-plus"></i> Nueva retirada
            </button>
        </header>

        <!-- STATS ROW -->
        <div class="grid grid-cols-2 sm:grid-cols-3 gap-4 mb-8 fade-in-up delay-100">
            <div class="bg-white rounded-[24px] p-5 shadow-sm border border-slate/5">
                <p class="text-xs font-bold text-slate/30 uppercase tracking-widest mb-1">Este mes</p>
                <p class="text-3xl font-bold text-slate" id="statMonth">—</p>
                <p class="text-xs text-slate/40 mt-1">retiradas registradas</p>
            </div>
            <div class="bg-white rounded-[24px] p-5 shadow-sm border border-slate/5">
                <p class="text-xs font-bold text-slate/30 uppercase tracking-widest mb-1">Total histórico</p>
                <p class="text-3xl font-bold text-slate" id="statTotal">—</p>
                <p class="text-xs text-slate/40 mt-1">registros totales</p>
            </div>
            <div class="col-span-2 sm:col-span-1 bg-amber-50 rounded-[24px] p-5 border border-amber-100">
                <p class="text-xs font-bold text-amber-600/60 uppercase tracking-widest mb-1">Marco legal</p>
                <p class="text-sm font-bold text-amber-700">RD 1/2008 · Clase III</p>
                <p class="text-xs text-amber-600/60 mt-1">Gestión por empresa autorizada</p>
            </div>
        </div>

        <!-- RECORDS TABLE -->
        <section class="bg-white rounded-[28px] shadow-sm border border-slate/5 overflow-hidden fade-in-up delay-200">
            <div class="px-6 sm:px-8 pt-6 pb-4 flex items-center justify-between border-b border-slate/5">
                <div>
                    <h2 class="text-lg font-bold text-slate">Historial de retiradas</h2>
                    <p class="text-sm text-slate/40 mt-0.5">Trazabilidad completa por recogida</p>
                </div>
            </div>
            <!-- Table header -->
            <div
                class="hidden sm:grid grid-cols-12 gap-4 text-xs font-bold text-slate/30 uppercase tracking-wider px-8 py-3 border-b border-slate/5">
                <div class="col-span-3">Gestor</div>
                <div class="col-span-3">Fecha retirada</div>
                <div class="col-span-3">Registrado por</div>
                <div class="col-span-2">Albarán</div>
                <div class="col-span-1 text-right">Acciones</div>
            </div>
            <div id="recordsContainer" class="px-4 sm:px-8 pb-4">
                <div class="py-12 text-center text-slate/30 text-sm" id="emptyState">
                    <i class="ph ph-biohazard text-4xl mb-3 block text-amber-200"></i>
                    Sin registros todavía.<br>Pulsa "Nueva retirada" para empezar.
                </div>
            </div>
        </section>
    </main>

    <!-- MODAL: NUEVA RETIRADA -->
    <div id="retiradaModal" class="fixed inset-0 z-[100] search-overlay hidden items-center justify-center">
        <div
            class="bg-white rounded-[32px] shadow-float w-full max-w-md mx-4 overflow-hidden border border-slate/10 animate-[fadeInUp_0.3s_ease]">
            <div class="px-8 py-6 border-b border-slate/5 flex items-center justify-between">
                <div>
                    <h2 class="text-xl font-bold text-slate">Nueva retirada</h2>
                    <p class="text-xs text-slate/40 mt-1">Residuos Biosanitarios Clase III</p>
                </div>
                <button onclick="closeModal()" class="text-slate/20 hover:text-slate transition-colors text-2xl">
                    <i class="ph ph-x"></i>
                </button>
            </div>
            <form id="retiradaForm" class="p-8 space-y-5">
                <div class="space-y-2">
                    <label class="text-[10px] font-bold text-slate/30 uppercase tracking-widest px-1">Gestor
                        autorizado</label>
                    <div class="relative">
                        <i class="ph ph-truck absolute left-4 top-1/2 -translate-y-1/2 text-slate/30"></i>
                        <input type="text" id="rGestor" required placeholder="Nombre de la empresa gestora"
                            class="w-full bg-cream border border-slate/5 rounded-2xl py-3.5 pl-11 pr-4 outline-none focus:ring-2 focus:ring-amber-200 focus:border-amber-300 transition-all text-sm font-medium text-slate">
                    </div>
                </div>
                <div class="space-y-2">
                    <label class="text-[10px] font-bold text-slate/30 uppercase tracking-widest px-1">Fecha de
                        retirada</label>
                    <div class="relative">
                        <i class="ph ph-calendar absolute left-4 top-1/2 -translate-y-1/2 text-slate/30"></i>
                        <input type="date" id="rDate" required
                            class="w-full bg-cream border border-slate/5 rounded-2xl py-3.5 pl-11 pr-4 outline-none focus:ring-2 focus:ring-amber-200 focus:border-amber-300 transition-all text-sm font-medium text-slate">
                    </div>
                </div>
                <div class="space-y-2">
                    <label class="text-[10px] font-bold text-slate/30 uppercase tracking-widest px-1">Nº de Albarán /
                        DCS</label>
                    <div class="relative">
                        <i class="ph ph-hash absolute left-4 top-1/2 -translate-y-1/2 text-slate/30"></i>
                        <input type="text" id="rAlbaran" placeholder="Ej: ALB-2024-001"
                            class="w-full bg-cream border border-slate/5 rounded-2xl py-3.5 pl-11 pr-4 outline-none focus:ring-2 focus:ring-amber-200 focus:border-amber-300 transition-all text-sm font-medium text-slate">
                    </div>
                </div>
                <div class="space-y-2">
                    <label class="text-[10px] font-bold text-slate/30 uppercase tracking-widest px-1">Foto del albarán
                        (evidencia)</label>
                    <div class="grid grid-cols-2 gap-3">
                        <button type="button" onclick="document.getElementById('rCamera').click()"
                            class="flex items-center justify-center gap-2 py-3.5 bg-cream rounded-2xl border border-slate/5 text-sm font-bold text-slate hover:bg-slate/5 transition-colors">
                            <i class="ph ph-camera text-amber-500"></i> Cámara
                        </button>
                        <button type="button" onclick="document.getElementById('rGallery').click()"
                            class="flex items-center justify-center gap-2 py-3.5 bg-cream rounded-2xl border border-slate/5 text-sm font-bold text-slate hover:bg-slate/5 transition-colors">
                            <i class="ph ph-images text-amber-500"></i> Galería
                        </button>
                    </div>
                    <input type="file" id="rCamera" accept="image/*" capture="environment" class="hidden">
                    <input type="file" id="rGallery" accept="image/*" class="hidden">
                    <div id="rPhotoPreview" class="hidden flex gap-2 flex-wrap pt-1"></div>
                </div>
                <button type="submit" id="rSubmitBtn"
                    class="w-full bg-amber-500 text-white py-4 rounded-2xl font-bold text-sm hover:bg-amber-600 transition-all active:scale-95">
                    Registrar retirada
                </button>
            </form>
        </div>
    </div>

    <!-- PHOTO VIEWER -->
    <div id="photoModal" class="fixed inset-0 z-[200] bg-slate/80 backdrop-blur-sm hidden items-center justify-center"
        onclick="this.classList.add('hidden');this.classList.remove('flex')">
        <img id="photoViewerImg" src="" class="max-w-[90vw] max-h-[85vh] rounded-3xl shadow-float object-contain">
    </div>

    <script type="module">
        import { supabase } from './supabase.js';
        let currentCompanyId = null;
        let _rFiles = [];

        async function checkSession() {
            const { data: { session } } = await supabase.auth.getSession();
            if (!session) {
                currentCompanyId = '00000000-0000-0000-0000-000000000001';
            } else {
                const { data: profile } = await supabase.from('profiles').select('company_id').eq('id', session.user.id).single();
                currentCompanyId = profile?.company_id || '00000000-0000-0000-0000-000000000001';
            }
            fetchRecords();
        }

        async function fetchRecords() {
            const { data } = await supabase.from('waste_records')
                .select('*').eq('company_id', currentCompanyId)
                .order('pickup_date', { ascending: false });

            const container = document.getElementById('recordsContainer');
            const empty = document.getElementById('emptyState');

            // Stats
            const now = new Date();
            const firstOfMonth = new Date(now.getFullYear(), now.getMonth(), 1).toISOString().split('T')[0];
            const thisMonth = (data || []).filter(r => r.pickup_date >= firstOfMonth).length;
            document.getElementById('statMonth').textContent = thisMonth;
            document.getElementById('statTotal').textContent = data?.length || 0;

            // Clear all rows (incluido el empty state)
            container.innerHTML = '';

            if (!data || data.length === 0) {
                container.innerHTML = `
                    <div class="py-12 text-center text-slate/30 text-sm">
                        <i class="ph ph-biohazard text-4xl mb-3 block text-amber-200"></i>
                        Sin registros todavía.<br>Pulsa "Nueva retirada" para empezar.
                    </div>`;
                return;
            }

            data.forEach(r => {
                const row = document.createElement('div');
                const noPhoto = !r.photo_urls || r.photo_urls.length === 0;
                row.className = `record-row sm:grid sm:grid-cols-12 gap-4 items-center py-4 border-b border-slate/5 flex flex-col sm:flex-row hover:bg-cream/50 transition-colors rounded-2xl px-2 group ${noPhoto ? 'bg-yellow-50/40' : ''}`;
                const dateStr = r.pickup_date ? new Date(r.pickup_date + 'T12:00:00').toLocaleDateString('es-ES', { day: 'numeric', month: 'short', year: 'numeric' }) : '—';
                const photoCell = noPhoto
                    ? `<span class="inline-flex items-center gap-1 text-xs font-bold text-yellow-600 bg-yellow-100 px-2 py-1 rounded-lg border border-yellow-200">
                           <i class="ph ph-warning"></i> Sin foto
                       </span>`
                    : `<button class="view-photo-btn text-amber-500 hover:text-amber-700 transition-colors" data-url="${r.photo_urls[0]}">
                           <i class="ph ph-image text-lg"></i>
                       </button>`;
                row.innerHTML = `
                    <div class="col-span-3 font-bold text-slate text-sm">${r.gestor_name || '—'}</div>
                    <div class="col-span-3 text-sm text-slate/60">${dateStr}</div>
                    <div class="col-span-3 text-xs text-slate/40 font-mono">${r.created_by || 'Sistema'}</div>
                    <div class="col-span-2 text-xs text-slate/50 font-mono">${r.albaran || '—'}</div>
                    <div class="col-span-1 text-right">${photoCell}</div>`;
                container.appendChild(row);
            });
        }

        // Photo viewer — registrado UNA sola vez fuera de fetchRecords
        document.getElementById('recordsContainer').addEventListener('click', e => {
            const btn = e.target.closest('.view-photo-btn');
            if (!btn) return;
            document.getElementById('photoViewerImg').src = btn.dataset.url;
            document.getElementById('photoModal').classList.remove('hidden');
            document.getElementById('photoModal').classList.add('flex');
        });

        // Modal
        window.openModal = function () {
            document.getElementById('retiradaForm').reset();
            _rFiles = [];
            document.getElementById('rPhotoPreview').innerHTML = '';
            document.getElementById('rPhotoPreview').classList.add('hidden');
            // Default date = today
            document.getElementById('rDate').value = new Date().toISOString().split('T')[0];
            const m = document.getElementById('retiradaModal');
            m.classList.remove('hidden'); m.classList.add('flex');
            setTimeout(() => document.getElementById('rGestor').focus(), 80);
        };
        window.closeModal = function () {
            const m = document.getElementById('retiradaModal');
            m.classList.add('hidden'); m.classList.remove('flex');
        };

        // File handling
        function handleFile(files) {
            const preview = document.getElementById('rPhotoPreview');
            for (const f of files) {
                _rFiles.push(f);
                const thumb = document.createElement('div');
                thumb.className = 'w-16 h-16 rounded-xl overflow-hidden border border-amber-100 cursor-pointer';
                thumb.innerHTML = `<img src="${URL.createObjectURL(f)}" class="w-full h-full object-cover">`;
                preview.appendChild(thumb);
            }
            preview.classList.remove('hidden');
        }
        document.getElementById('rCamera').onchange = e => handleFile(e.target.files);
        document.getElementById('rGallery').onchange = e => handleFile(e.target.files);

        // Submit
        document.getElementById('retiradaForm').onsubmit = async (e) => {
            e.preventDefault();
            const btn = document.getElementById('rSubmitBtn');
            btn.disabled = true; btn.textContent = 'Guardando...';

            const photoUrls = [];
            for (const file of _rFiles) {
                const path = `residuos/${currentCompanyId}/${Date.now()}_${file.name}`;
                await supabase.storage.from('treatment-photos').upload(path, file).catch(() => { });
                const { data: { publicUrl } } = supabase.storage.from('treatment-photos').getPublicUrl(path);
                photoUrls.push(publicUrl);
            }

            await supabase.from('waste_records').insert({
                company_id: currentCompanyId,
                gestor_name: document.getElementById('rGestor').value.trim(),
                pickup_date: document.getElementById('rDate').value,
                albaran: document.getElementById('rAlbaran').value.trim() || null,
                photo_urls: photoUrls,
                class: 'III'
            }).catch(() => { });

            btn.textContent = '✓ Registrado';
            setTimeout(() => {
                closeModal();
                btn.disabled = false;
                btn.textContent = 'Registrar retirada';
                fetchRecords();
            }, 900);
        };

        checkSession();
    </script>
    <script src="./navigation.js"></script>
</body>

</html>